<!--

    Unless explicitly acquired and licensed from Licensor under another license, the contents of
    this file are subject to the Reciprocal Public License ("RPL") Version 1.5, or subsequent
    versions as allowed by the RPL, and You may not copy or use this file in either source code
    or executable form, except in compliance with the terms and conditions of the RPL

    All software distributed under the RPL is provided strictly on an "AS IS" basis, WITHOUT
    WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, AND LICENSOR HEREBY DISCLAIMS ALL SUCH
    WARRANTIES, INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY, FITNESS FOR A
    PARTICULAR PURPOSE, QUIET ENJOYMENT, OR NON-INFRINGEMENT. See the RPL for specific language
    governing rights and limitations under the RPL.

    http://opensource.org/licenses/RPL-1.5

    Copyright 2012-2017 Open Justice Broker Consortium

-->
<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
	<head>
		<title>Disposition Form</title>
		<th:block th:include="fragments/general.html :: headerfiles"></th:block>
		<link rel="stylesheet" type="text/css" th:href="@{/webjars/datatables/1.10.19/css/dataTables.bootstrap4.min.css}" />
		<link rel="stylesheet" type="text/css" th:href="@{/webjars/font-awesome/5.2.0/css/all.css}" />
		<link href="https://cdn.jsdelivr.net/npm/gijgo@1.9.10/css/gijgo.min.css" rel="stylesheet" type="text/css" />
	</head>
	<body>
	    <!-- Begin page content -->
  <div th:fragment="dispositionForm">
    
    <form action="#" th:action="@{/arrests/saveDisposition}" th:object="${disposition}" id="dispositionForm" method="post">
      <input type="hidden" th:field="*{arrestIdentification}" />
      <input type="hidden" th:field="*{dispositionIdentification}" />
      <input type="hidden" th:field="*{arrestDate}" />
      <div class="form-row">
        <div class="col-md-6 mb-2">
          <label>Charge at Arrest</label>
          <select th:field="*{arrestChargeIdentification}" class="form-control form-control-sm chosen-select" th:errorclass="is-invalid">
          </select>
        </div>
        <div class="col-md-6 mb-2">
          <label>Court Name</label>
          <input type="text" th:field="*{muniCourtName}" class="form-control form-control-sm" readonly/>
        </div>
      </div>
      <div class="form-row">
          <div class="col-md-3 mb-2">
           <label>Disposition Date
             <a href="#" data-toggle="popover" data-trigger="hover" 
                data-content="The date the 'disposition code' action occurred.  Includes case filings, dismissals, pleas and findings, etcâ€¦">
                <i class="fas fa-info-circle"></i></a>
           </label>
           <input type="text" th:field="*{dispositionDate}" placeholder="mm/dd/yyyy" class="date form-control form-control-sm" th:errorclass="is-invalid"/>
           <div th:if="${#fields.hasErrors('dispositionDate')}" th:errors="*{dispositionDate}" class="invalid-feedback">Disposition Date error message</div>
         </div>
         <div class="col-md-4 mb-2">
           <label for="dispositionCode">Disposition *
             <a href="#" data-toggle="popover" data-trigger="hover" 
                data-content="Result of the hearing.">
                <i class="fas fa-info-circle"></i></a>
           </label>
           <select th:field="*{dispositionCode}" class="form-control form-control-sm chosen-select" th:errorclass="is-invalid">
              <option value="" >Please select ...</option>
				    <option th:each="item: ${dispoCodeMapping}" th:value="${item.key}" th:text="${item.value}" />
           </select>
           <div th:if="${#fields.hasErrors('dispositionCode')}" th:errors="*{dispositionCode}" class="invalid-feedback">Disposition Code error message</div>
         </div>
         <div class="col-md-2 mb-2">
           <label for="counts">Counts*
             <a href="#" data-toggle="popover" data-trigger="hover" 
                data-content="This will default to 1. Increase as needed if the subject was charged with the same offense more than once resulting in the same disposition.  There is a maximum of 999.">
                <i class="fas fa-info-circle"></i></a>
           </label>
           <input type="number" min="1" max="99" th:field="*{counts}" width="1" class="form-control form-control-sm" th:errorclass="is-invalid"/>
           <div th:if="${#fields.hasErrors('counts')}" th:errors="*{counts}" class="invalid-feedback">Counts error message</div>
         </div>
         <div class="col-md-3 mb-2">
           <label>Court Case Number 
             <a href="#" data-toggle="popover" data-trigger="hover" 
                data-content="If Court Case Number is not available use Citation Number.">
                <i class="fas fa-info-circle"></i></a>
           </label>
           <input type="text" th:field="*{courtCaseNumber}" class="form-control" th:errorclass="is-invalid"/>
           <div th:if="${#fields.hasErrors('courtCaseNumber')}" th:errors="*{courtCaseNumber}" class="invalid-feedback">Court Case Number error message</div>
         </div>
      </div>
      <div class="form-row">
        <div class="col-md-6 mb-2">
          <label>Filed Charge *
            <a href="#" data-toggle="popover" data-trigger="hover" 
               data-content="Original charge as filed. The arrest that the defendant is charged with can be same or different from charge at arrest.">
               <i class="fas fa-info-circle"></i></a>
          </label>
          <input type="text" th:field="*{filedChargeLiteral}" class="form-control form-control-sm mb-1" readonly data-toggle="popover" data-trigger="hover" 
               data-content="Filed Charge Literal"/>
	        <select th:field="*{filedCharge}" class="form-control form-control-sm chosen-select" th:errorclass="is-invalid">
	           <option value="" >Please select ...</option>
	           <option th:each="item: ${muniFiledChargeCodeMapping}" th:value="${item.key}" th:text="${item.value}" />
	        </select>
          <div th:if="${#fields.hasErrors('filedCharge')}" th:errors="*{filedCharge}" class="invalid-feedback">Filed charge error message</div>
        </div>
        <div class="col-md-6 mb-2">
          <label>Amended Charge
            <a href="#" data-toggle="popover" data-trigger="hover" 
               data-content="The offense that the defendant is sentenced for is different from filed charge. ">
               <i class="fas fa-info-circle"></i></a>
          </label>
          <input type="text" th:field="*{amendedChargeLiteral}" class="form-control form-control-sm mb-1" readonly data-toggle="popover" data-trigger="hover" 
               data-content="Amended Charge Literal"/>
          <select th:field="*{amendedCharge}" class="form-control form-control-sm chosen-select" th:errorclass="is-invalid" disabled>
             <option value="" >Please select ...</option>
             <option th:each="item: ${muniAmendedChargeCodeMapping}" th:value="${item.key}" th:text="${item.value}" />
          </select>
          <div th:if="${#fields.hasErrors('amendedCharge')}" th:errors="*{amendedCharge}" class="invalid-feedback">Amended charge error message</div>
        </div>
      </div>
      <div class="form-row">
        <div class="col-md-6 mb-2">
          <label>Fine Amount</label>
          <input type="text" th:field="*{fineAmount}" width="250" class="money form-control form-control-sm " th:errorclass="is-invalid"/>
          <div th:if="${#fields.hasErrors('fineAmount')}" th:errors="*{fineAmount}" class="invalid-feedback">Fine amount error message</div>
        </div>
        <div class="col-md-6 mb-2">
          <label>Fine Suspended
            <a href="#" data-toggle="popover" data-trigger="hover" 
               data-content="Must be less than or equal to the fine amount.">
               <i class="fas fa-info-circle"></i></a>
          </label>
          <input type="text" th:field="*{fineSuspended}" width="250" class="money form-control form-control-sm " th:errorclass="is-invalid"/>
          <div th:if="${#fields.hasErrors('fineSuspended')}" th:errors="*{fineSuspended}" class="invalid-feedback">Fine suspended error message</div>
        </div>
      </div>
      <div class="form-row">
        <div class="col-md-2 mb-2">
          <label>Jail Years
            <a href="#" data-toggle="popover" data-trigger="hover" 
               data-content="Jail is served in County Jail. Jail Years must be blank or 1, Jail Days cannot exceed 359.">
               <i class="fas fa-info-circle"></i></a>
          </label>
          <input type="number" min="1" max="1" th:field="*{jailYears}" width="1" class="form-control form-control-sm provision-prerequisite jail-time" th:errorclass="is-invalid"/>
          <div th:if="${#fields.hasErrors('jailYears')}" th:errors="*{jailYears}" class="invalid-feedback">Jail years error message</div>
        </div>
        <div class="col-md-2 mb-2">
          <label>Jail Days
            <a href="#" data-toggle="popover" data-trigger="hover" 
               data-content="Jail is served in County Jail. Jail Years must be blank or 1, Jail Days cannot exceed 359.">
               <i class="fas fa-info-circle"></i></a>
          </label>
          <input type="number" min="1" max="359" th:field="*{jailDays}" width="3" class="form-control form-control-sm provision-prerequisite jail-time" th:errorclass="is-invalid"/>
          <div th:if="${#fields.hasErrors('jailDays')}" th:errors="*{jailDays}" class="invalid-feedback">Jail days error message</div>
        </div>
        <div class="col-md-2 mb-2">
          <label>Suspended Year
            <a href="#" data-toggle="popover" data-trigger="hover" 
               data-content="Suspended time cannot be greater than Jail time. ">
               <i class="fas fa-info-circle"></i></a>
          </label>
          <input type="number" min="1" max="1" th:field="*{suspendedYears}" width="1" class="form-control form-control-sm suspended-time" th:errorclass="is-invalid" disabled/>
          <div th:if="${#fields.hasErrors('suspendedYears')}" th:errors="*{suspendedYears}" class="invalid-feedback">Suspended years error message</div>
        </div>
        <div class="col-md-2 mb-2">
          <label>Suspended Days
            <a href="#" data-toggle="popover" data-trigger="hover" 
               data-content="Suspended time cannot be greater than Jail time. ">
               <i class="fas fa-info-circle"></i></a>
          </label>
          <input type="number" min="1" max="359" th:field="*{suspendedDays}" width="3" class="form-control form-control-sm suspended-time"  th:errorclass="is-invalid" disabled/>
          <div th:if="${#fields.hasErrors('suspendedDays')}" th:errors="*{suspendedDays}" class="invalid-feedback">Suspended days error message</div>
        </div>
        <div class="col-md-2 mb-2">
          <label>Deferred Years      
              <a href="#" data-toggle="popover" data-trigger="hover" 
               data-content="Days cannot exceed 359.  Each month = 30 days. 6 months = 180 days. 
                Cannot have deferred time and Suspended time for same charge. Does not result in a conviction on the rap sheet. ">
               <i class="fas fa-info-circle"></i></a>
          </label>
          <input type="number" min="1" max="1" th:field="*{deferredYears}" width="1" class="form-control form-control-sm provision-prerequisite" th:errorclass="is-invalid"/>
          <div th:if="${#fields.hasErrors('deferredYears')}" th:errors="*{deferredYears}" class="invalid-feedback">Deferred years error message</div>
        </div>
        <div class="col-md-2 mb-2">
          <label>Deferred Days
            <a href="#" data-toggle="popover" data-trigger="hover" 
               data-content="Days cannot exceed 359.  Each month = 30 days. 6 months = 180 days. 
                Cannot have deferred time and Suspended time for same charge. Does not result in a conviction on the rap sheet. ">
               <i class="fas fa-info-circle"></i></a>
          </label>
          <input type="number" min="1" max="359" th:field="*{deferredDays}" width="3" class="form-control form-control-sm provision-prerequisite" th:errorclass="is-invalid"/>
          <div th:if="${#fields.hasErrors('deferredDays')}" th:errors="*{deferredDays}" class="invalid-feedback">Deferred days error message</div>
        </div>
      </div>
      <div class="form-row">
        <div class="col-md-6 mb-2">
          <label>Restitution</label>
          <input type="text" th:field="*{restitution}" width="10" class="money form-control form-control-sm " th:errorclass="is-invalid"/>
          <div th:if="${#fields.hasErrors('restitution')}" th:errors="*{restitution}" class="invalid-feedback">Restitution error message</div>
        </div>					                
        <div class="col-md-6 mb-2">
          <label>Additional Sentence
            <a href="#" data-toggle="popover" data-trigger="hover" 
               data-content="Any disposition that cannot be reported using one of the other fields and can be used as an additional sentencing.">
               <i class="fas fa-info-circle"></i></a>
          </label>
          <select th:field="*{alternateSentences}" class="form-control form-control-sm chosen-select" multiple="multiple" th:errorclass="is-invalid" data-placeholder="Please select all that apply...">
            <option value="" ></option>
            <option th:each="item: ${muniAlternateSentenceMapping}" th:value="${item.key}" th:text="${item.value}"/>
          </select>
          <div th:if="${#fields.hasErrors('alternateSentences')}" th:errors="*{alternateSentences}" class="invalid-feedback">Alternate sentence error message</div>
        </div>		
      </div>			                
      <div class="form-group">
        <label>Reason For Dismissal
          <a href="#" data-toggle="popover" data-trigger="hover" 
             data-content="Include, if known, whenever the disposition code is CHARGES DISMISSED.">
             <i class="fas fa-info-circle"></i></a>
        </label>
        <select th:field="*{reasonForDismissal}" class="form-control form-control-sm chosen-select" th:errorclass="is-invalid" disabled>
          <option value="" >Please select ...</option>
          <option th:each="item: ${muniReasonsForDismissalMapping}" th:value="${item.key}" th:text="${item.value}" />
        </select>
        <div th:if="${#fields.hasErrors('reasonForDismissal')}" th:errors="*{reasonForDismissal}" class="invalid-feedback">Reason for dismissal error message</div>
      </div>					                
      <div class="form-group">
        <label>Provision
          <a href="#" data-toggle="popover" data-trigger="hover" 
             data-content="Concurrent sentences run at the same time; Consecutive sentences run one after another.  ">
             <i class="fas fa-info-circle"></i></a>
        </label>
	      <select th:field="*{provisionCode}" class="form-control form-control-sm chosen-select" th:errorclass="is-invalid" disabled>
	         <option value="" >Please select ...</option>
	         <option th:each="item: ${provisionCodeMapping}" th:value="${item.key}" th:text="${item.value}" />
	      </select>
        <div th:if="${#fields.hasErrors('provisionCode')}" th:errors="*{provisionCode}" class="invalid-feedback">Provision error message</div>
      </div>					                
    </form>
    <script th:inline="javascript">
	      $(function(){
	    	  $('[data-toggle="popover"]').prop('tabIndex', -1).popover();
          $("#dispositionForm").on("focus", "#dispositionDate", function(){
              $('#dispositionDate').datepicker({
                  uiLibrary: 'bootstrap4', size: 'small'
               });
          });
	    	  $(".chosen-select").chosen(); 
          $("#arrestChargeIdentification").trigger('chosen:activate');

					$('.date').mask('99/99/9999');
					$('.money').mask('0,000,000,000,000', {reverse: true});
					
					// 43 -> 348 - Found guilty of different charge
					// 70 -> 376 - pled guilty of other charge
					//107 -> 520 - Nolo contendere to different charge
					var dispoCodesForAmendedCharge = ['43', '70', '107'];
					
					// 6 -> 305
					var dispoCodesForDismissalReason = ['6']; //305-charge dismissal
					
					console.log($('#dispositionCode').val());
					if (dispoCodesForAmendedCharge.includes($('#dispositionCode').val())){
					 $('#amendedCharge').prop('disabled', false).trigger("chosen:updated");
					}
	     	   
					if (dispoCodesForDismissalReason.includes($('#dispositionCode').val())){
					 $('#reasonForDismissal').prop('disabled', false).trigger("chosen:updated");
					}
	     	  
					toggleAlternateSentenceFineCostsOption();
					toggleAlternateSentenceRestitutionOption();
					toggleSentenceInfo();
					toggleProvisionCode();
					
          $("#dispositionForm").on("change", "#fineAmount", function(){
            toggleAlternateSentenceFineCostsOption();
          });
			             
          $("#dispositionForm").on("change", "#restitution", function(){
            toggleAlternateSentenceRestitutionOption();
          });
          
					if ($('#jailYears').val() > 0){
            $('#jailDays').val(''); 
            $('#jailDays').prop('disabled', true); 
            $('#deferredYears').val(''); 
            $('#deferredDays').val(''); 
					 	$('#deferredYears').prop('disabled', true); 
					 	$('#deferredDays').prop('disabled', true); 
					}
					
					if ($('#jailDays').val() > 0){
            $('#deferredYears').val(''); 
            $('#deferredDays').val(''); 
            $('#deferredYears').prop('disabled', true); 
            $('#deferredDays').prop('disabled', true); 
					}
					
					toggleSuspendedInputs();
					
			    if ($('#deferredYears').val() > 0){
             $('#deferredDays').prop('disabled', true); 
          }
					
          $("#dispositionForm").on("change", "#jailYears", function(){
              if ($('#jailYears').val() > '0'){
                  $('#jailDays').val(''); 
                  $('#jailDays').prop('disabled', true); 
                  $('#deferredYears').val(''); 
                  $('#deferredDays').val(''); 
                  $('#deferredYears').prop('disabled', true); 
                  $('#deferredDays').prop('disabled', true);
              }
              else{
              	  $('#jailDays').prop('disabled', false);
                  toggleDefferredYearsDays();              
              }
           	  toggleSuspendedInputs();
          });
					
          $("#dispositionForm").on("change", ".provision-prerequisite", function(){
        	  toggleProvisionCode();
          });
          
          $("#dispositionForm").on("change", "#jailDays", function(){
              if ($('#jailDays').val() > 0){
                  $('#suspendedDays').prop('disabled', false); 
                  $('#deferredYears').val(''); 
                  $('#deferredYears').prop('disabled', true); 
                  $('#deferredDays').val(''); 
                  $('#deferredDays').prop('disabled', true); 
              }
              else{
                  toggleDefferredYearsDays();
              }
          });
          
          $("#dispositionForm").on("change", "#deferredYears", function(){
              if ($('#deferredYears').val() > 0){
                  $('#deferredDays').val(''); 
                  $('#deferredDays').prop('disabled', true); 
              }
              else{
                  $('#deferredDays').prop('disabled', false); 
              }
          });
					
          $("#dispositionForm").on("change", "#suspendedYears", function(){
              if ($('#suspendedYears').val() > 0){
                  $('#suspendedDays').val(''); 
                  $('#suspendedDays').prop('disabled', true); 
              }
              else{
                  $('#suspendedDays').prop('disabled', false); 
              }
          });
					
		  	  $("#dispositionForm").on("change", "#dispositionCode", function(){
		          if (dispoCodesForAmendedCharge.includes($('#dispositionCode').val())){
		            $('#amendedCharge').prop('disabled', false).trigger("chosen:updated");
	            }
		          else{
		        	  $('#amendedCharge').val('');
		        	  $('#amendedCharge').prop('disabled', true).trigger("chosen:updated");
		          }
		          
		          if (dispoCodesForDismissalReason.includes($('#dispositionCode').val())){
		        	  $('#reasonForDismissal').prop('disabled', false).trigger("chosen:updated");
		          }
		          else{
		        	  $('#reasonForDismissal').val('');
		        	  $('#reasonForDismissal').prop('disabled', true).trigger("chosen:updated");
		          }
		          
		          toggleSentenceInfo();
		  	  });
		  	  
          $('#dispositionForm input').keypress(function (e) {
              if (e.which == 13) {
                $('#saveDisposition').click();
                return false;    
              }
          });


        });
	      
	      function toggleDefferredYearsDays(){
	    	  /* 74 -> 380, 82->388 */
          var dispoCodesWithoutDeferredYearsDays = ['74', '82'];

           if (dispoCodesWithoutDeferredYearsDays.includes($('#dispositionCode').val())){
               $('#deferredYears').val('');
               $('#deferredYears').prop('disabled', true);
               $('#deferredDays').val('');
               $('#deferredDays').prop('disabled', true);
           }
           else{
               $('#deferredYears').prop('disabled', false);
               $('#deferredDays').prop('disabled', false);
           }
	      }
	      
	      function toggleProvisionCode(){
	            var $provisionPrerequisiteInputs = $('.provision-prerequisite');
	            if ($provisionPrerequisiteInputs.filter(function(){
	            		  return $(this).val() > 0;
	            	}).length){
	              $('#provisionCode').prop('disabled', false).trigger("chosen:updated");
	            }
	            else{
	            	$('#provisionCode').val('');
	              $('#provisionCode').prop('disabled', true).trigger("chosen:updated");
	            }
	      }
	      
	      function toggleSuspendedInputs(){
            var $jailTimeInputs = $('.jail-time');
            if ($jailTimeInputs.filter(function(){
            		  return $(this).val() > 0;
            	}).length){
            	   if ($("jailDays").val() > 0){
	            	   $('#suspendedDays').prop('disabled', false);
            	   }
            	   else{
	            	   $('#suspendedYears').prop('disabled', false); 
                   if ($('#suspendedYears').val() > 0){
                       $('#suspendedDays').prop('disabled', true); 
                   }
                   else{
                       $('#suspendedDays').prop('disabled', false);
                   }
            	   }
            }
            else{
            	  $('#suspendedYears').val('');
                $('#suspendedYears').prop('disabled', true); 
                $('#suspendedDays').val('');
                $('#suspendedDays').prop('disabled', true); 
            }
	      }
	      
	      function toggleSentenceInfo(){
	    	  /* 2 -> 301
	    	     6 -> 305
	    	    23 -> 326
	    	    71 -> 377
	    	    28 -> 331
	    	   162 -> 538
	    	    89 -> 398
	    	  */
          var dispoCodesWithoutSentence = ['2', '6', '23', '71', '28', '162', '89'];

          if (dispoCodesWithoutSentence.includes($('#dispositionCode').val())){
               $('#fineAmount').val('');
               $('#fineAmount').prop('disabled', true);
               $('#fineSuspended').val('');
               $('#fineSuspended').prop('disabled', true);
               $('#jailYears').val('');
               $('#jailYears').prop('disabled', true);
               $('#jailDays').val('');
               $('#jailDays').prop('disabled', true);
               $('#suspendedYears').val('');
               $('#suspendedYears').prop('disabled', true);
               $('#suspendedDays').val('');
               $('#suspendedDays').prop('disabled', true);
               $('#deferredYears').val('');
               $('#deferredYears').prop('disabled', true);
               $('#deferredDays').val('');
               $('#deferredDays').prop('disabled', true);
               $('#restitution').val('');
               $('#restitution').prop('disabled', true);
               $('#alternateSentences option').removeAttr('selected');
               $('#alternateSentences').prop('disabled', true).trigger("chosen:updated");
         }
         else{
               $('#fineAmount').prop('disabled', false);
               $('#fineSuspended').prop('disabled', false);
               $('#jailYears').prop('disabled', false);
               $('#jailDays').prop('disabled', false);
               toggleDefferredYearsDays();
               $('#restitution').prop('disabled', false);
               $('#alternateSentences').prop('disabled', false);
               toggleAlternateSentenceFineCostsOption();
               toggleAlternateSentenceRestitutionOption();
         }

      }
	      
      function toggleAlternateSentenceFineCostsOption(){
          if ($("#fineAmount").val() > 0){
              $('#alternateSentences option[value="28"]').prop('disabled', true);
              $('#alternateSentences option[value="30"]').prop('disabled', true);
              $('#alternateSentences option[value="62"]').prop('disabled', true);
              $('#alternateSentences option[value="63"]').prop('disabled', true);
              $('#alternateSentences option[value="27"]').prop('disabled', true);
              $('#alternateSentences option[value="64"]').prop('disabled', true).trigger("chosen:updated");
          }
          else{
              $('#alternateSentences option[value="28"]').prop('disabled', false);
              $('#alternateSentences option[value="30"]').prop('disabled', false);
              $('#alternateSentences option[value="62"]').prop('disabled', false);
              $('#alternateSentences option[value="63"]').prop('disabled', false);
              $('#alternateSentences option[value="27"]').prop('disabled', false);
              $('#alternateSentences option[value="64"]').prop('disabled', false).trigger("chosen:updated");
          }
      }
      
      function toggleAlternateSentenceRestitutionOption(){
          if ($("#restitution").val() > 0){
              $('#alternateSentences option[value="37"]').prop('disabled', true);
              $('#alternateSentences option[value="38"]').prop('disabled', true).trigger("chosen:updated");
          }
          else{
              $('#alternateSentences option[value="37"]').prop('disabled', false);
              $('#alternateSentences option[value="38"]').prop('disabled', false).trigger("chosen:updated");
          }
      }
	        
    </script>
  </div>
	</body>
</html>
